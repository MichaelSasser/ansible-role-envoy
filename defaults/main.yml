---
# defaults file for ansible-role-envoy

envoy_docker_image: envoyproxy/envoy
envoy_docker_image_tag: v1.24-latest
envoy_container_name: envoy

envoy_networks:
  - name: "{{ docker_network_name }}"

envoy_container_memory_limit: null
envoy_upgrade: no

envoy_port: 80
envoy_port_ssl: 443
envoy_admin_port: 9901

envoy_node_id: id_0
envoy_node_cluster: cluster_0

envoy_config_directory: /envoy/config

envoy_config_path: "{{ envoy_config_directory }}/envoy.yaml"
envoy_lds_config_path: "{{ envoy_config_directory }}/lds.yaml"
envoy_cds_config_path: "{{ envoy_config_directory }}/cds.yaml"

envoy_admin_interface_socket_address: { address: 0.0.0.0, port_value: 9901 }

envoy_service_config: # Mandatory
  lds: ""
  rds: ""
  cds: ""
  eds: ""
  sds_tls: ""
  sds_validation_context: ""

envoy_xds_config:
  - config: envoy
    dest: "{{ envoy_config_path }}"
    data: "{{ envoy_config }}"
  - config: lds
    dest: "{{ envoy_lds_config_path }}"
    data:
      udp: "{{ envoy_service_config.lds_udp  | flatten(levels=1) }}"
      tcp: "{{ envoy_service_config.lds_tcp  | flatten(levels=1) }}"
  - config: rds
    dest: "{{ envoy_config_directory }}/rds.yaml"
    data: "{{ envoy_service_config.rds  | flatten(levels=1) }}"
  - config: cds
    dest: "{{ envoy_cds_config_path }}"
    data: "{{ envoy_service_config.cds  | flatten(levels=1) }}"
  - config: eds
    dest: "{{ envoy_config_directory }}/eds.yaml"
    data: "{{ envoy_service_config.eds  | flatten(levels=1) }}"
  - config: sds
    dest: "{{ envoy_config_directory }}/sds_tls.yaml"
    data: "{{ envoy_service_config.sds_tls  | flatten(levels=1) }}"
  - config: sds
    dest: "{{ envoy_config_directory }}/sds_validation_context.yaml"
    data: "{{ envoy_service_config.sds_validation_context  | flatten(levels=1) }}"

envoy_config:
  ####################################################################
  # NODE CONFIGURATION
  ####################################################################
  node:
    id: "{{ envoy_node_id }}"
    cluster: "{{ envoy_node_cluster }}"

  ####################################################################
  # DYNAMIC CONFIGURATION
  ####################################################################
  dynamic_resources:
    cds_config:
      resource_api_version: V3
      path_config_source:
        path: "{{ envoy_cds_config_path }}"
        watched_directory:
          path: "{{ envoy_config_directory }}"
    lds_config:
      resource_api_version: V3
      path_config_source:
        path: "{{ envoy_lds_config_path }}"
        watched_directory:
          path: "{{ envoy_config_directory }}"

  ####################################################################
  # ADMIN INTERFACE
  ####################################################################
  admin:
    address:
      socket_address: "{{ envoy_admin_interface_socket_address }}"

  ####################################################################
  # RUNTIME LAYER
  ####################################################################
  layered_runtime:
    layers:
      - name: static_layer_0
        static_layer:
          envoy:
            resource_limits:
              listener:
                listener_http:
                  connection_limit: 50
                listener_tcp:
                  connection_limit: 150
                listener_udp:
                  connection_limit: 150
          overload:
            global_downstream_max_connections: 200

  ####################################################################
  # OVERLOAD MANAGER
  ####################################################################
  overload_manager:
    refresh_interval: 0.25s
    resource_monitors:
      - name: "envoy.resource_monitors.fixed_heap"
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.resource_monitors.fixed_heap.v3.FixedHeapConfig
          max_heap_size_bytes: 536870912 # 512 MiB
    actions:
      - name: "envoy.overload_actions.shrink_heap"
        triggers:
          - name: "envoy.resource_monitors.fixed_heap"
            threshold:
              value: 0.95
      - name: "envoy.overload_actions.stop_accepting_requests"
        triggers:
          - name: "envoy.resource_monitors.fixed_heap"
            threshold:
              value: 0.98
