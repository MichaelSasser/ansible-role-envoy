---
# defaults file for ansible-role-envoy

envoy_docker_image: envoyproxy/envoy
envoy_docker_image_tag: v1.24-latest
envoy_container_name: envoy

envoy_networks:
  - name: "{{ docker_network_name }}"

envoy_container_memory_limit: null
envoy_upgrade: no

envoy_port: 80
envoy_port_ssl: 443
envoy_admin_port: 9901

envoy_node_id: id_0
envoy_node_cluster: cluster_0

envoy_config_directory: /envoy/config

envoy_config_path: "{{ envoy_config_directory }}/envoy.yaml"
envoy_lds_config_path: "{{ envoy_config_directory }}/lds.yaml"
envoy_rds_config_path: "{{ envoy_config_directory }}/rds.yaml"
envoy_cds_config_path: "{{ envoy_config_directory }}/cds.yaml"
envoy_eds_config_path: "{{ envoy_config_directory }}/eds.yaml"
envoy_sds_tls_config_path: "{{ envoy_config_directory }}/sds_tls.yaml"
envoy_sds_validation_context_config_path: "{{ envoy_config_directory }}/sds_validation_context.yaml"

envoy_admin_interface_socket_address: { address: 0.0.0.0, port_value: 9901 }

envoy_service_config: # Mandatory
  lds_tcp: "{{ null | default(omit) }}"
  lds_udp: "{{ null | default(omit) }}"
  rds: "{{ null | default(omit) }}"
  cds: "{{ null | default(omit) }}"
  eds: "{{ null | default(omit) }}"
  sds_tls: "{{ null | default(omit) }}"
  sds_validation_context: "{{ null | default(omit) }}"

envoy_config:
  ####################################################################
  # NODE CONFIGURATION
  ####################################################################
  node:
    id: "{{ envoy_node_id }}"
    cluster: "{{ envoy_node_cluster }}"

  ####################################################################
  # DYNAMIC CONFIGURATION
  ####################################################################
  dynamic_resources:
    cds_config:
      resource_api_version: V3
      path_config_source:
        path: "{{ envoy_cds_config_path }}"
        watched_directory:
          path: "{{ envoy_config_directory }}"
    lds_config:
      resource_api_version: V3
      path_config_source:
        path: "{{ envoy_lds_config_path }}"
        watched_directory:
          path: "{{ envoy_config_directory }}"

  ####################################################################
  # ADMIN INTERFACE
  ####################################################################
  admin:
    address:
      socket_address: "{{ envoy_admin_interface_socket_address }}"

  ####################################################################
  # STATIC RESOURCES
  ####################################################################
  static_resources:
    # ####################################################################
    # # SECRETS CONFIGURATION
    # ####################################################################
    # secrets:
    #   - "{{ envoy_service_config.secrets  | flatten(levels=1) }}"

  ####################################################################
  # RUNTIME LAYER
  ####################################################################
  layered_runtime:
    layers:
      - name: static_layer_0
        static_layer:
          envoy:
            resource_limits:
              listener:
                listener_http:
                  connection_limit: 50
                listener_tcp:
                  connection_limit: 150
                listener_udp:
                  connection_limit: 150
          overload:
            global_downstream_max_connections: 200

  ####################################################################
  # OVERLOAD MANAGER
  ####################################################################
  overload_manager:
    refresh_interval: 0.25s
    resource_monitors:
      - name: "envoy.resource_monitors.fixed_heap"
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.resource_monitors.fixed_heap.v3.FixedHeapConfig
          max_heap_size_bytes: 536870912 # 512 MiB
    actions:
      - name: "envoy.overload_actions.shrink_heap"
        triggers:
          - name: "envoy.resource_monitors.fixed_heap"
            threshold:
              value: 0.95
      - name: "envoy.overload_actions.stop_accepting_requests"
        triggers:
          - name: "envoy.resource_monitors.fixed_heap"
            threshold:
              value: 0.98

envoy_lds_config:
  resources:
    ####################################################################
    # TCP (HTTP) - 80/TCP - Redirect
    ####################################################################
    - name: listener_http
      "@type": type.googleapis.com/envoy.config.listener.v3.Listener
      address:
        socket_address: { address: "::", port_value: 8080, ipv4_compat: true }
      filter_chains:
        - filters:
            - name: envoy.filters.network.http_connection_manager
              typed_config:
                "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
                codec_type: AUTO
                stat_prefix: ingress_http
                use_remote_address: true
                normalize_path: true
                merge_slashes: true
                path_with_escaped_slashes_action: UNESCAPE_AND_REDIRECT
                common_http_protocol_options:
                  idle_timeout: 3600s # 1 hour
                  headers_with_underscores_action: REJECT_REQUEST
                http2_protocol_options:
                  max_concurrent_streams: 100
                  initial_stream_window_size: 65536 # 64 KiB
                  initial_connection_window_size: 1048576 # 1 MiB
                stream_idle_timeout: 300s # 5 mins, must be disabled for long-lived and streaming requests
                request_timeout: 300s # 5 mins, must be disabled for long-lived and streaming requests
                route_config:
                  name: local_route
                  virtual_hosts:
                    - name: backend
                      response_headers_to_add:
                        - header:
                            key: alt-svc
                            value: h3=":443"; ma=86400, h3-29=":443"; ma=86400
                      domains:
                        - "*"
                      routes:
                        - match:
                            prefix: "/"
                          redirect:
                            path_redirect: "/"
                            https_redirect: true
                http_filters:
                  - name: envoy.filters.http.router
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router

    ####################################################################
    # TCP (HTTP/2) - 443/TCP
    ####################################################################
    - name: listener_tcp
      "@type": type.googleapis.com/envoy.config.listener.v3.Listener
      address:
        socket_address:
          { protocol: TCP, address: "::", port_value: 4443, ipv4_compat: true }
      listener_filters:
        - name: "envoy.filters.listener.tls_inspector"
          typed_config:
            "@type": type.googleapis.com/envoy.extensions.filters.listener.tls_inspector.v3.TlsInspector
      per_connection_buffer_limit_bytes: 32768 # 32 KiB
      filter_chains:
        - "{{ envoy_service_config.lds_tcp  | flatten(levels=1) }}"

    ####################################################################
    # UDP (HTTP/3 / QUIC) - 443/UDP
    ####################################################################
    - name: listener_udp
      "@type": type.googleapis.com/envoy.config.listener.v3.Listener
      address:
        socket_address:
          { protocol: UDP, address: "::", port_value: 4443, ipv4_compat: true }
      udp_listener_config:
        quic_options: {}
        downstream_socket_config:
          prefer_gro: true
      per_connection_buffer_limit_bytes: 32768 # 32 KiB
      filter_chains:
        - "{{ envoy_service_config.lds_udp  | flatten(levels=1) }}"

envoy_rds_config:
  version_info: "0"
  resources:
    - "{{ envoy_service_config.rds  | flatten(levels=1) }}"

envoy_cds_config:
  resources:
    - "{{ envoy_service_config.cds  | flatten(levels=1) }}"

envoy_eds_config:
  version_info: "0"
  resources:
    - "{{ envoy_service_config.eds  | flatten(levels=1) }}"

envoy_sds_tls_config:
  resources:
    - "{{ envoy_service_config.sds_tls  | flatten(levels=1) }}"

envoy_sds_validation_context_config:
  resources:
    - "{{ envoy_service_config.sds_validation_context  | flatten(levels=1) }}"
